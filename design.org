* Example

Duration: 1 month

** transaction 01

date: 2014/10/2
|------------+-----------|
| store code | item code |
|------------+-----------|
|       0001 |      1491 |
|       0002 |      5810 |
|       0001 |      5819 |
|------------+-----------|

itemSoldDates(sorted set)
|--------------------+----------|
| 0001:1491:20141002 | 20141002 |
| 0002:5810:20141002 | 20141002 |
| 0001:5819:20141002 | 20141002 |
|--------------------+----------|

itemItem:0001:1491:20141002(hash)
|-----------+---|
| 0002:5810 | 1 |
| 0001:5819 | 1 |
|-----------+---|

itemItem:0002:5810:20141002(hash)
|-----------+---|
| 0001:1491 | 1 |
| 0001:5819 | 1 |
|-----------+---|

itemItem:0001:5819:20141002(hash)
|-----------+---|
| 0001:1491 | 1 |
| 0002:5810 | 1 |
|-----------+---|

itemItemSum1m:0001:1491(sorted set)
|-----------+---|
| 0002:5810 | 1 |
| 0001:5819 | 1 |
|-----------+---|

itemItemSum1m:0002:5810(sorted set)
|-----------+---|
| 0001:1491 | 1 |
| 0001:5819 | 1 |
|-----------+---|

itemItemSum1m:0001:5819(sorted set)
|-----------+---|
| 0001:1491 | 1 |
| 0002:5810 | 1 |
|-----------+---|

** transaction 02

date: 2014/10/2
|------------+-----------|
| store code | item code |
|------------+-----------|
|       0001 |      1491 |
|       0001 |      5819 |
|       0003 |      8172 |
|------------+-----------|

itemSoldDates(sorted set)
|--------------------+----------|
| 0001:1491:20141002 | 20141002 |
| 0002:5810:20141002 | 20141002 |
| 0001:5819:20141002 | 20141002 |
| 0003:8172:20141002 | 20141002 |
|--------------------+----------|

itemItem:0001:1491:20141002(hash)
|-----------+---|
| 0002:5810 | 1 |
| 0001:5819 | 2 |
| 0003:8172 | 1 |
|-----------+---|

itemItem:0002:5810:20141002(hash)
|-----------+---|
| 0001:1491 | 1 |
| 0001:5819 | 1 |
|-----------+---|

itemItem:0001:5819:20141002(hash)
|-----------+---|
| 0001:1491 | 2 |
| 0002:5810 | 1 |
| 0003:8172 | 1 |
|-----------+---|

itemItem:0003:8172:20141002(hash)
|-----------+---|
| 0001:1491 | 1 |
| 0001:5819 | 1 |
|-----------+---|

itemItemSum1m:0001:1491(sorted set)
|-----------+---|
| 0002:5810 | 1 |
| 0001:5819 | 2 |
| 0003:8172 | 1 |
|-----------+---|

itemItemSum1m:0002:5810(sorted set)
|-----------+---|
| 0001:1491 | 1 |
| 0001:5819 | 1 |
|-----------+---|

itemItemSum1m:0001:5819(sorted set)
|-----------+---|
| 0001:1491 | 2 |
| 0002:5810 | 1 |
| 0003:8172 | 1 |
|-----------+---|

itemItemSum1m:0003:8172(sorted set)
|-----------+---|
| 0001:1491 | 1 |
| 0001:5819 | 1 |
|-----------+---|

** transaction 03

date: 2014/10/10
|------------+-----------|
| store code | item code |
|------------+-----------|
|       0001 |      1491 |
|       0003 |      8172 |
|------------+-----------|

itemSoldDates(sorted set)
|--------------------+----------|
| 0001:1491:20141002 | 20141002 |
| 0002:5810:20141002 | 20141002 |
| 0001:5819:20141002 | 20141002 |
| 0003:8172:20141002 | 20141002 |
| 0001:1491:20141010 | 20141010 |
| 0003:8172:20141010 | 20141010 |
|--------------------+----------|

itemItem:0001:1491:20141002(hash)
|-----------+---|
| 0002:5810 | 1 |
| 0001:5819 | 2 |
| 0003:8172 | 1 |
|-----------+---|

itemItem:0001:1491:20141010(hash)
|-----------+---|
| 0003:8172 | 1 |
|-----------+---|

itemItem:0002:5810:20141002(hash)
|-----------+---|
| 0001:1491 | 1 |
| 0001:5819 | 1 |
|-----------+---|

itemItem:0001:5819:20141002(hash)
|-----------+---|
| 0001:1491 | 2 |
| 0002:5810 | 1 |
| 0003:8172 | 1 |
|-----------+---|

itemItem:0003:8172:20141002(hash)
|-----------+---|
| 0001:1491 | 1 |
| 0001:5819 | 1 |
|-----------+---|

itemItem:0003:8172:20141010(hash)
|-----------+---|
| 0001:1491 | 1 |
|-----------+---|

itemItemSum1m:0001:1491(sorted set)
|-----------+---|
| 0002:5810 | 1 |
| 0001:5819 | 2 |
| 0003:8172 | 2 |
|-----------+---|

itemItemSum1m:0002:5810(sorted set)
|-----------+---|
| 0001:1491 | 1 |
| 0001:5819 | 1 |
|-----------+---|

itemItemSum1m:0001:5819(sorted set)
|-----------+---|
| 0001:1491 | 2 |
| 0002:5810 | 1 |
| 0003:8172 | 1 |
|-----------+---|

itemItemSum1m:0003:8172(sorted set)
|-----------+---|
| 0001:1491 | 2 |
| 0001:5819 | 1 |
|-----------+---|

** expire (batch 1 / day)

Date: 2014/11/6

30 days before = 2014/10/7

Query itemSoldDates before 2014/10/7

itemSoldDates(sorted set) before 2014/10/7
|--------------------+----------|
| 0001:1491:20141002 | 20141002 |
| 0002:5810:20141002 | 20141002 |
| 0001:5819:20141002 | 20141002 |
| 0003:8172:20141002 | 20141002 |
|--------------------+----------|

Access "itemItem:" + these key:

itemItem:0001:1491:20141002(hash)
|-----------+---|
| 0002:5810 | 1 |
| 0001:5819 | 2 |
| 0003:8172 | 1 |
|-----------+---|

itemItem:0002:5810:20141002(hash)
|-----------+---|
| 0001:1491 | 1 |
| 0001:5819 | 1 |
|-----------+---|

itemItem:0001:5819:20141002(hash)
|-----------+---|
| 0001:1491 | 2 |
| 0002:5810 | 1 |
| 0003:8172 | 1 |
|-----------+---|

itemItem:0003:8172:20141002(hash)
|-----------+---|
| 0001:1491 | 1 |
| 0001:5819 | 1 |
|-----------+---|

Subtract these count from itemItemSum1m.

itemItemSum1m:0001:1491(sorted set)
|-----------+---|
| 0002:5810 | 0 |
| 0001:5819 | 0 |
| 0003:8172 | 1 |
|-----------+---|

itemItemSum1m:0002:5810(sorted set)
|-----------+---|
| 0001:1491 | 0 |
| 0001:5819 | 0 |
|-----------+---|

itemItemSum1m:0001:5819(sorted set)
|-----------+---|
| 0001:1491 | 0 |
| 0002:5810 | 0 |
| 0003:8172 | 0 |
|-----------+---|

itemItemSum1m:0003:8172(sorted set)
|-----------+---|
| 0001:1491 | 1 |
| 0001:5819 | 0 |
|-----------+---|

Delete all the following itemItem keys:

itemItem:0001:1491:20141002
itemItem:0002:5810:20141002
itemItem:0001:5819:20141002
itemItem:0003:8172:20141002

